# 引入三方 AI 引擎

前边，我们实现了与云库对战的象棋游戏。这一节中，我们将开始实现真正的「人机」对战 — 人与手机 AI 之间对弈；

实现一套象棋 AI 工程浩大，这个工作我们后续文章会做一番介绍。现代软件工程并不主张每个人都「造轮子」，因此我们要有「站在巨人肩膀上」的小智慧。

## 本节概要

  * 从 github 寻找开源中象引擎
  * 梳理引擎接入的思路

## 寻找适合的开源中国象棋引擎

github 上有大量的开源中国象棋引擎，我们可以前往学习和借鉴。

在 github.com 搜索「Chinese Chess Engine」，这儿能找到的中国象棋引擎多达百款，各种语言和平台的实现都有。

考虑到我们的游戏将运行在 iOS、Android 甚至桌面平台上，我们应该选择 C/C++ 的源代码类型，它便于我们能过 ObjectC Bridge 和
JNI 等方式与原生应用融合开发。

选择 C 或 C++ 作为语言筛选，我们看到 [xqbase/eleeye](https://github.com/xqbase/eleeye)
得星140枚，是这块排名最高的项目了，我们就选它做为我们的单机游戏引擎吧。

![在 github 上搜索 Chinese Chess Engine](https://images.gitbook.cn/uetIDL.png)

点击复制 eleeye 仓库的地址：

![复制 eleeye 项目的 git 地址](https://images.gitbook.cn/GhIwrN.png)

在命令行输入 `git clone https://github.com/xqbase/eleeye.git` 将仓库克隆到本地。

查看一下项目的 readme，可以发现这个项目包含了很多内容，包括基于 Windows 的界面工具，棋谱转换工具等一系列内容集合。我们关心的单机引擎是放在
eleeye 子文件夹（注意它的项目根目录也叫 eleeye）下的。

![项目根目下的 eleeye 文件夹下放置的是引擎代码](assets/snipaste_2020-03-17_20-08-24.png)

我们将 eleeye 子文件夹复制到我们 chessroad 的项目根目录下，并将 BOOK 目录下的 BOOK.DAT 文件也复制到 chessroad
的项目根目下。这就为后续的衔接开发做好了准备。

## 理一理引擎接入的头绪

接入第三方引擎不是一个小工程，而且有一定的复杂度，但大家要坚定信念，我们能搞定这个困难问题！

面对复杂的工作，我们先规划一下接下来的开发思路。我计划的步骤大体是这的：

  1. 在 Flutter 和原生应用之间定义基于 UCCI 的通信接口
  2. 认真了读一读 eleeye 引擎的源码，理清人家引擎的工作机制，找到协作入口
  3. 在理解 eleeye 基础上，我们选择引擎的工作模式
  4. 创建与引擎的沟通通道和必要的协作工具类
  5. 在 iOS 和 Android 中分别实现 Flutter 的 MethodChannel 通道

理出一个头绪后，我们发现需要以下几个方面的知识才能完成后续的工作，大家可以有侧重地做一些准备工作：

> 如果你并不具备这些知识、或不具备全部这些知识，那问题也不大 — 先跟着我做吧，在实践中学习：

  * [Flutter 与原生应用之间的协作](https://flutter.cn/docs/development/platform-integration/platform-channels)机制 — MethodChannel 工作方式
  * 最有具备 C/C++ 的基本知识
  * 对[中国象棋通用引擎协议 UCCI](docs/中国象棋通用引擎协议-UCCI) 有一定了解，我们将在后续工作中用到协议指令
  * 在 iOS 开发中，使 Object-C / Swfit 融合 C / C++ 开发的基本知识
  * 在 Android 开发中，使 Java / Kotlin 融合 C / C++ 开发的基本知识

我们先来考虑 Flutter 与引擎之间使用 UCCI 通信的逻辑。

在整个与引擎下棋的过程中，我们与引擎之间有以下一些沟通需求：

  * 启动引擎
  * 使引擎进入就绪状态
  * 设置开局库
  * 读取引擎当前状态（就绪、搜索中）
  * 启动搜索
  * 取消当前搜索
  * 读取搜索结果
  * 关闭引擎

将这些需求都翻译成 UCCI 的指令，就是我们与引擎之间的接口了。

## 小节回顾

我们首先在 github 上搜索了中国象棋引擎，然后找到了「象眼」 eleeye 引擎做为我们的 AI 开源引擎。

然后，我们做了简单的准备工作，提示大家学习 Flutter 与宿主平台之间通过 Method Channel
通信的知识。最后，我们梳理了将三方引擎置入到我们的象棋游戏中的基本步骤。

## 拓展知识

作为开发人员，从 github 中寻找资源或思路是常用的技巧。真实项目中，我就是通过 github 找到了 eleeye 来做为「棋路」的 AI 引擎的。

现实中，选择一个开源的、像 eleeye 这么浩大的项目为自己的项目所用，其判断过程肯定要更谨慎的。我们要考虑的不可能是是开源项目的 Star 数量。

一般来说，我们先得获取多个开源项目的源码，浏览源码的质量、组织方式、License
许可、依赖环境等多种因素。最终也是最重要的一是是：对多个开源项目的源码做测试，根据其表现来选择合适的源码。

通常对开源项目的可用性判断依据如下：

  * 解决业务逻辑的能力强，比如象棋的 AI，棋力应该要很高。
  * 依赖环节少，且可以在自己的项目环境中快速构建此依赖
  * 代码可读性要高
  * License 限制要可接受

