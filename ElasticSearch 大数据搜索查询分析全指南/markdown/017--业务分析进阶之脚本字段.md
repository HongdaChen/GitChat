### 脚本字段

在我们设定好索引类型之后，只能根据设定好的索引字段进行索引，以电子商务为例，每条数据包含的字段有，用户名、用户的邮箱、用户性别、产品类别等可以设置为文本类型，下单时间可以设置为时间类型，价格等字段可以设置为浮点型，整型等。我们来看一下电子商务的字段类型是怎么设置的。

  1. 先点击设置
  2. 选择 Kibana
  3. 点击索引模型
  4. 选择电子商务索引
  5. 我们可以看到不同的字段类型是什么样的
  6. 是否可以聚合，是否可以搜索这个页面都可以看到

![image-20191211212342430](https://images.gitbook.cn/2020-04-07-063222.png)

但是这有个缺陷，就是我们只能够查询已经设定好的字段，如果想查一些自定义数据就很难，比如就以用户消费金额来说吧，商务电子订单单位是美元，如果是我们去看呢？想把美元转成人民币来查看，实际上就是想在原有字段上加上一点运算，这个需求是很常见的。

### 自定义脚本字段

**给定需求：** 查看用户消费金额，单位是人民币

  1. 选择设置
  2. 选择索引模式
  3. 选择脚本字段
  4. 选择添加脚本字段

![image-20191211215436551](https://images.gitbook.cn/2020-04-07-063223.png)

  1. 名称这里自定义一个 taxful _total_ price_rmb
  2. 语言默认选用 painless
  3. 类型选择 number
  4. 数据格式选择 Number

![image-20191211215954864](https://images.gitbook.cn/2020-04-07-063224.png)

  1. 脚本输入：doc["taxful _total_ price"].value*7 
  2. 预览脚本结果
  3. 点击运行脚本
  4. 查看运行的结果

从结果上来看，这些字段值都被乘以 7 了。预览如果没问题的话，我们就可以直接点击创建字段。

![image-20191211220225352](https://images.gitbook.cn/2020-04-07-063225.png)

### 查看脚本字段

  1. 这时可以看到脚本字段显示有 1 个
  2. 脚本字段详情也显示出来了

![image-20191217205613455](https://images.gitbook.cn/2020-04-07-063226.png)

回到 Discover 界面查看这个字段，发现已经能够查看了，这个字段的值是实时计算的，所以不建议将复杂的运算设置为脚本字段，因为这样会拖慢 ES 性能。

![image-20191217205655648](https://images.gitbook.cn/2020-04-07-063227.png)

刚接触 Kibana 你可能急需这可需求，但是你又不知道如何搜索，这是很痛苦的，在我接触 ES
初期就遇到这么尴尬的情景，我遇到这样的需求但是又很难表达出来，最后才发现还有脚本字段这么方便的工具。当时笔者遇到的需求大概是：日志产生的时候有个时间戳，当存到
ES 的时候也会参数一个时间戳，想要用柱状图的方式看看数据的延迟情况。

**给定需求：** 查看两个时间字段的差，实际上查看数据延迟，就是对两个时间字段作差

  1. 命名为 DifferenceTime
  2. 选择 painless
  3. 类型选择 number
  4. 格式选择 Duration
  5. 输入格式为毫秒
  6. 格式选择默认

![image-20191216213701242](https://images.gitbook.cn/2020-04-07-63228.png)

  1. 脚本 _new Date().getTime()-doc["order_date"].value.getMillis()_ ，这里我使用现在的时间作为延迟后的时间，下单时间作为实时的时间，两个以毫秒为单位作差

![image-20191216213942501](https://images.gitbook.cn/2020-04-07-063229.png)

  1. 查看时间的差，为 9 天。因此可以得到两个时间的差。

![image-20191216214151349](https://images.gitbook.cn/2020-04-07-063230.png)

### 小结

脚本字段提供了更加灵活的数据展示方式，但是由于性能原因最好不要使用，尽量在自定义 schame 的时候多考虑一些因素指标。

