Elasticsearch 的免费版本中不包含安全防护机制，安全保护功能在商业组件 X-Pack 中提供，属于付费功能。

如果不使用 X-Pack 作为安全组件，也可以使用 Nginx 反向代理，自己编写插件，或者其他厂商开发的插件，如 SG 等方式。

官方的 X-Pack 提供安全保护比较全面，包括：

  * 身份认证，鉴定用户是否合法
  * 用户鉴权，指定某个用户可以访问哪个索引
  * 传输加密，使用 SSL/TLS 加密节点间的传输，防止监听和篡改
  * 审计日志，记录用户对系统执行了哪些操作

如果反向代理不能满足你的需求，我们推荐使用 X-Pack 作为 Elasticsearch 的安全防护组件。

### 1\. 身份认证

验证用户身份，这是安全策略的第一步。为了让具有合法身份的用户才可以访问系统，在认证体系中通常考虑三种类型：

  * 你知道什么。这种类型让用户提供用户名和密码的方式
  * 你有什么。这种类型一般让用户提供秘钥或 kerberos 票据等方式
  * 你是谁。一般使用生物识别技术

X-Pack 中使用前两种对用户进行身份认证。对于客户端提交的用户名和密码如何进行校验？在 X-Pack 中可以使用 LDAP，或者 Active
Directory 等后端认证服务器，这些认证服务在 X-Pack 中被称为 Realms，你可以使用内置的基于文件的认证，或者通过插件实现自定义
Realm。

除了使用用户和名密码进行身份认证之外，客户端也可以通过 Kerberos 票据等方式进行认证，这种方式需要准备好票据文件。

内置的 Realms 有如下类型：

#### 1.1 内置 Realm

内置 Realm 的身份认证过程完全由 X-Pack 实现，无需借助于外部系统，用户信息在内部管理。

**native**

支持以用户名和密码的方式进行认证，Elasticsearch 将用户信息存储到集群的索引中。

**file**

与 native 的区别是将用户信息存储到本地磁盘的文件中，这个文件需要同步到集群的每个节点。

#### 1.2 外部 Realm

外部认证使用其他的第三方进行身份认证，常见的场景是接入企业内部已有的认证服务器进行统一的用户管理。

例如企业内部有许多的大数据平台，每个平台都需要进行身份认证，为每个平台单独建立用户体系是不合理的，因此通常使用统一的用户体系进行管理。目前我们使用
ldap。

**1\. ldap**

使用后端 ldap 服务器进行认证，认证方式也是用户名和密码的方式，许多公司有内部的 ldap 服务器来管理用户，这种方式可以使用统一的账号管理体系。

**2\. active_directory**

通过微软的活动目录服务器验证用户名和密码，在 Windows 系统中，活动目录服务器用于域模式下的用户管理。

**3\. pki**

基于公钥进行身份认证。

**4\. saml**

使用 SAML 2.0 Web SSO 进行身份认证

**5\. kerberos**

使用 kerberos 进行身份认证，客户端需要准备好 kerberos 票据文件。

经过对用户的身份认证之后，系统已经安全很多，只有合法用户才能访问集群，不会被人任意操作。

现在面临新的问题是：所有的用户对集群都拥有完整的管理权限，有时候我们希望现在用户的某些行为。

例如，我希望某个用户只访问他自己的索引，并且限制他不能执行集群管理操作，这就需要我们对用户进行鉴权，对于某个特定用户，他可以有哪些权限。

### 2\. 用户鉴权

X-Pack 提供的用户鉴权是基于角色的访问控制，简称为 RBAC。RBAC
首先定义一个角色，为这个角色分配一组权限，权限支持索引级和字段级。然后再将角色分配给用户或用户组。

例如定义一个角色 role_weblog，为这个角色分配可以访问索引 `weblog-*` 的写入和读取权限，然后为用户 A 和用户 B
都分配这个角色，他们就都拥有了索引 `weblog-*` 的读写权限。

一个用户可以同时拥有多个角色，某个角色也可以分配给多个用户。

**RBAC 有以下重要的概念：**

**1\. Secured Resource**

要描述对资源有哪些权限，首先需要定义资源是什么。在 Elasticsearch
中，资源包括：索引、别名、文档、字段、用户、以及集群本身。这些都是受保护的资源。

**2\. Privilege**

用于描述用户可以对资源执行什么样的操作，每个资源有自己的一组 Privilege 名称，例如：

对于索引这种资源有： _create_ ， _delete_ ， _read_ ， _write_ 等。 对于集群，有： _manage_ ，
_monitor_ 等。

**3\. Permissions**

由一个或多个对资源的特定 Privilege 组成，例如，对索引 `weblog-*` 的 read 权限。

**4\. Role** 一系列 Permissions 的组合，例如，对索引 `weblog-*` 的 read 权限，以及集群的 monitor
权限组成一个角色。

**5\. User** 被鉴权的用户

**6\. Group** 用户可以属于一个或多个组，不过有些 realms 不支持用户组，例如 native、file、以及 PKI 。

当某个角色分配给用户组时，组中的用户所拥有的最终角色为：分配给用户组的角色加分配给该用户的角色的组合。同样，用户拥有的权限为其所拥有的全部角色的并集。

X-Pack
还支持基于属性的访问控制，把属性分配给用户和文档，再到角色中定义访问策略，具有该角色的用户只有在具备必需的属性时才能访问特定文档。不在本文论述范围。

### 3\. 通讯加密

早期的 X-Pack 版本中，身份认证可以单独开启，现在则要求在开启身份认证的同时必须同时开启内部节点之间的通讯加密（单节点的集群除外）。

X-Pack 安全组件中的通讯加密支持客户端到集群的通讯加密，以及集群节点之间内部通讯的加密，这些都通过 TLS/SSL
实现。其中客户端到集群的通讯加密是可选的。

如果不加密节点之间的通讯，攻击者可以通过抓包获取到明文的数据，包括集群状态，索引数据内容等，这些数据都可能是机密信息。攻击者甚至可以篡改这些数据。

另外攻击者也可以尝试自己启动节点加入集群。节点间的通讯加密就是为了阻止这些情况。

开启节点间的通讯加密大致需要以下两个步骤：

  * 生成节点证书
  * 修改节点配置，启用 TLS

配置完毕后需要对集群执行完全重启。

### 总结

当集群开启身份认证之后，Kibana，Logstash，Beats，java 客户端等都需要调整相应的配置。

本文介绍了目前的版本中 X-Pack
提供的安全防护功能，并重点介绍了身份认证和用户鉴权的基础知识，接下来我们会以一些例子实际操作一下身份认证、用户鉴权、以及通信加密的具体配置方法及注意事项。

下一课程我们介绍如何部署和应用身份认证。

### 参考

[1] [Realms](https://www.elastic.co/guide/en/elastic-stack-
overview/6.5/realms.html#_internal_and_external_realms)

[2] [Security privilegesedit](https://www.elastic.co/guide/en/elastic-stack-
overview/6.5/security-privileges.html)

[3] [User authorizationedit](https://www.elastic.co/guide/en/elastic-stack-
overview/6.5/authorization.html)

* * *

### 交流与答疑

> **为了方便与作者交流与学习，GitChat 编辑团队组织了一个《高可用 Elasticsearch 集群 21 讲》读者交流群，添加小助手-
> 伽利略微信：「GitChatty6」，回复关键字「244」给小助手-伽利略获取入群资格。**
>
> 阅读文章过程中有任何疑问随时可以跟其他小伙伴讨论，或者直接向作者提问（作者看到后抽空回复）。你的分享不仅帮助他人，更会提升自己。

