由于我去年出版的《Elasticsearch 源码解析与优化实战》比较偏重原理，所以本套课程决定偏重应用和实践，主要讨论实际场景中应该如何正确使用
Elasticsearch，避免产生不要必要的问题，以及当线上集群出现故障时，如何分析和解决问题。

读者可以参考课程中的故障处理案例来解决遇到的类似问题，但是一定要和结合实际情况，避免照搬套用，只要你清楚问题的本质，结合实际场景，就能找到适合自己的解决方法。

本课程并未涉及到写入速度优化，查询速度优化等方面的内容，因为关于“优化”方面的话题在《Elasticsearch
源码解析与优化实战》中已经系统的讨论过，因此不再写重复的内容，读者有这方面的兴趣可以参考此书。

其实只要使用方法正确，Elasticsearch 很少会出问题，中小型公司 hold 住自己的集群完全没有问题。

Elastic 毕竟是一家商业公司，产品的质量控制比 Apache 的开源软件要好的多，重大 bug
很少，用户调研做的也很细致，对于用户在社区反馈痛点问题也一定会尽快解决，这也是 Elasticsearch 版本更新如此之快的原因。关于如何“正确地”使用
Elasticsearch，我们归纳为以下几个重点：

**1\. 合理设置 mapping**

最基础的，你要了解分词和不分词的区别，他们可能会在你的使用过程中造成完全不同的系统压力，例如我们曾经帮客户处理的一个性能问题中，客户需求是从 url
中根据域名能够检索到内容，由于不了解分词与不分词的区别，对 url 字段使用了 keyword 类型，查询时使用通配符查询： **www.url.cn**
的形式，这种查询由于需要遍历所有词，造成单个查询就把磁盘 IO 负载跑满，查询延迟巨大。

而这种查询本来用 text 类型加 match
查询就完全满足。类似这种低级的问题一定要避免，如果你不清楚某些技术点，就要把它搞懂，不要实验了一种方式满足了业务需求，完全不关心背后的代价。

就像这个例子中，业务使用通配符查询确实也能查到预期结果，以为这样就完成了自己的工作目标，结果是给后续工作挖了坑。

又例如数字类型，我们说对于没有范围查询需求的数字类型应该设置为 keyword，因为 Lucene
内部会把所有的数字类型都转为字符串进行处理，对于范围查找这种功能，Lucene 内部将数字字符串分解为多个，范围查询本质上是一个 term
查询，由于数字被分词为多个字符串，因此数字类型产生更多的倒排索引，最终占用更多的 JVM 常驻内存。

**2\. 了解搜索的代价**

搜索最容易产生问题的地方在于深度搜索和深度翻页。在我们处理过的各种问题中，很多业务确实不了解深层聚合会给集群带来什么样的压力，曾经有一个业务的集群总是在某个特定的时间点有节点离线的情况，业务抱怨集群不稳定，经过检查后发现业务的聚合请求的
bucket 为 1000000 * 1000000，这就很容易造成节点 OOM，又或者业务进行3层或4层的深度聚合，一样会造成协调节点内存暴涨。

7.x 之前的版本的断路器是限制不住内存使用量的，只能分离出单独的查询节点来解决问题，7.x
的版本中断路器可以更精确的控制内存使用。有些业务说深层聚合避免不了，必须要用，只能给协调节点配置上百 GB 的内存。

**3\. 控制好 JVM 内存**

绝大部分问题的根源是内存问题引起的，夸张一点说：只要你控制住 JVM 内存使用率在合理的范围，没有产生严重的 GC，你就可以拥有一个稳定的
Elasticsearch 集群。

造成 JVM 占用量很高的的因素很多，最大的因素是节点所持有的数据量，在不使用冻结索引的情况下，一个 open 状态的索引其 FST
结构要加载到内存中，这些是无法 GC 掉的，当节点的数据总量达到一定规模，你什么都不做，节点的 JVM
占用率就已经很高，一般我们建议单个节点持有的数据量不超过 5TB。

因此如果单个节点需要持有的数据量很多，就必须使用冻结索引。Lucene 8 宣称词典将由堆外内存的方式加载（off-heap），实际效果尚需验证。值得期待。

**4\. 避免数据热点**

要避免热点数据集中在少数几节点上，从而导致性能瓶颈，这通过 `index.total_shards_per_node`
来进行控制，他限制某个索引在单个节点上的分片数来让分片在节点间更均匀一些。如果集群已经产生热点问题，可以通过 reroute 来手工移动分片。

但是如果热点数据集中在某个磁盘，会比较难处理一些，如果不改动核心代码，只能 reroute 或尝试使用 raid 来解决，目前 Elasticsearch
对于多数据盘的管理确实还有待改进，相信后续的版本会解决这个问题。

上面我们总结了“正确地”使用 Elasticsearch 的要点，这是常见问题中占比重最多的问题，除此之外还会有些其他的细节，例如一个 bulk 请求达到
1GB，单条 doc 上百 M 同样导致节点 OOM，这些都是使用上的问题，类似的细节问题我们已经在课程中详细的讨论过。

对于任何一个大数据平台，要想用好它，都要了解他的技术特点，例如 hbase 的 rowkey 设计要避免热点，合理地控制 split 和 compation
等，只有足够的了解，才能避免不必要的问题。

