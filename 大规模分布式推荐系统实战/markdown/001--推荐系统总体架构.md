> 本文除了技术，其他纯属虚构。

### 背景说明

地鼠商城，英文名 DMall，是一家综合性电商平台，此为背景。

我是这家公司的开发/打杂工程师，主要负责数据分析、处理、线上服务、前端 UI 等打杂工作，公司成立之初我就来了，算是“开司”元老了。

起初地鼠商城的商品并不多，寥寥数千，种类也不多，受众比较小，进入商城的大部分用户都是老用户，新用户占比比较小，而且大部分用户都是带着很强的目的性，知道自己想买什么，经数据分析发现
95% 的用户打开地鼠 App 的第一件事就是 点击搜索栏，90% 以上的订单都是由搜索带来的，所以这个时候并不需要推荐$^1$。

由于 BOSS
的英明神武，地鼠的知名度越来越高，规模也越来越大，入驻的商家越来越多，商品和用户都出现了快速增长的趋势，渐渐的就有店家抱怨自己的店铺一个月也卖不出几单，有的用户就抱怨自己想要的东西总是要在搜索栏里输入
**很长的搜索词** 以及 **翻很多页** 才能找到。

数据同样也佐证了，商城的日活商品由几千到几万并且达到现在的数十万级别，日活用户也达到了百万级别，初步的估计用不了多久商品数量会达到百万，用户达到千万级别。

为了解决商品库存积压越来越多以及用户体验越来越差的重要问题，解除地鼠商城的重大危机，我临危受命，连夜开始撰写—— **地鼠商城个性化推荐架构详细设计** 。

> 推荐系统发挥作用一般需要以下两个前提：
>
>   1. 信息过载，系统内具有海量的信息，十万甚至百万千万级；
>   2. 用户意图不明确，大多数用户可能没有特别明确的意图，因为对于有明确意图的用户，搜索系统就能够满足用户需求了。
>

>
> 当信息体量达到一定的量级，无论对于消费者还是生产者都会带来很大的挑战：
>
>   1. 消费者，如何从海量商品中很容易的发现自己满意的商品，甚至由系统主动推送用户可能感兴趣的商品？
>   2.
> 生产者，如何让售卖的商品能够更加精准的定位到受众用户？比如，剃须刀商家就不大希望自己的产品对女性用户展示太多；母婴用品商家也不太可能愿意看到自己的商品展示给过多的未婚用户。
>

>
> 这就是推荐系统要解决的问题。

### 总体架构

总的来说，一个完整的推荐系统，基本上由三部分组成：

**1\. 召回**

针对不同的用户，可以从数百万的商品中召出不同的百/千量级的商品，称为召回集/候选集。

**2\. 排序**

召回集一般是由多个召回算法召回的结果融合而成，称为多路召回。

不同的召回算法内部的排序机制可能不一致，比如有的召回集按照 0~1 的打分排序，而有的按照 1~5 的打分排序。

需要一个统一的排序算法对多路召回的结果做一个最终的打分/排序。

**3\. 重排序**

排序之后，一般需要针对具体的业务会有人工干预在里面，比如无货无价过滤、新品提权、同品种打散等。

如下图所示（简化了用户请求，仅从推荐系统的角度，忽略了前端页面、后端服务等组成部分）：

![总体架构](https://images.gitbook.cn/aa063550-2643-11eb-96ab-0d95f8d73f7e)

当一个用户打开地鼠商城 App：

  * 推荐引擎接收到了用户请求（1）
  * 推荐引擎请求召回服务，获取到该用户的推荐候选集（2、3）
  * 推荐引擎获取到候选集之后，继续请求排序服务，得到排好序的结果集（4、5）
  * 再请求重排序服务，对结果集做最终的处理，包括无货过滤、无价（没有价格）过滤、热门商品提权、新品提权等（6、7）
  * 返回最终结果，展示给用户（8）

可以看到，推荐引擎是一个类似发动机的角色，运转着整个系统，将不同的服务串联起来，共同实现了千人千面的个性化推荐。

那么，作为推荐整体中唯二重要的两个服务——召回和排序，其内部又是怎样工作的呢？下面就来大致了解一下。

### 召回服务

![召回服务](https://images.gitbook.cn/10d9e880-2644-11eb-90f6-fbd19bda6e6e)

召回服务收到推荐引擎的请求之后：

  * 根据用户携带的信息（比如用户 ID、行为信息、手机型号等），执行多路召回算法。
  * 多路召回并行运行，获取该用户对应的召回集，比如召回算法 1 是协同过滤、召回算法 2 是 Word2Vec 等等，每种召回算法都能召出不同个数的商品。
  * 召回主程序将多路结果融合，返回给推荐引擎。

### 排序服务

![排序服务](https://images.gitbook.cn/2a9f0bb0-2644-11eb-96ab-0d95f8d73f7e)

排序服务收到推荐引擎的排序请求后：

  * 根据携带的用户信息、上下文信息（手机型号、操作系统等）以及召回服务返回的召回集，抽取相应的特征，将原始特征转换成算法可以识别的特征（比如，商品的 ID 作 hash，用户的行为序列 embedding 后作 sum pooling 等）。
  * 抽取特征完成后，输入对应的模型（比如 FM、Wide and Deep$^2$ 等）中。
  * 模型得到特征后，结合自身的参数，进行各种计算，得到召回集中每个商品的得分，排序返回给推荐引擎。

### 专栏结构

召回算法和排序算法作为推荐系统中最重要的两个部分，本专栏也将专注于对这两个部分的讲解，由浅入深，让读者明白一套完整的推荐系统的内部是如何运作的；当面对海量数据时，应该如何去做数据分析、特征挖掘以及模型构建等。

**第一部分：召回算法**

  * 经典的协同过滤，以及如何实现实时更新的协同过滤
  * 关联规则的原理、实现及其使用场景
  * Word2Vec 等向量化算法：原理以及实现
  * LSH、HNSW 等多种最近邻搜索算法，用于向量化算法生成的向量如何找到最相似向量
  * Youtube 的召回架构
  * 以上所有算法的离线评测机制：合理的离线评测，避免了上线观察指标，极大降低了风险和损失，提高算法迭代的速度

**第二部分：排序算法**

  * 最佳实践 1：特征工程和特征选择
  * 最佳实践 2：学习率策略、损失函数、激活函数、Dropout 等等
  * 最佳实践 3：如何调参
  * Wide and Deep、DeepFM 等经典排序模型的建模技巧
  * 排序模型的离线评估
  * 正负样本失衡、正样本延迟等问题的解决办法
  * 冷启动机制
    * 用户冷启动：新用户该怎么推荐？
    * 物品冷启动：新商品该怎么推荐？

**第三部分：分布式 TensorFlow**

  * 分布式训练的运行机制
  * 分布式 TensorFlow 代码编写，包括数据读取、分片以及训练、验证到最终的模型存储等
  * 生产中常用的分布式 TensorFlow 训练框架，基于 Kubernetes、Horovod 等

专栏假设读者具备基本的 Python 编写能力，会阅读基本的 Spark
程序，不过不用担心，熟悉了算法原理之后，代码只是一种翻译工具，你可以使用你熟悉的语言去实现专栏里的所有算法。

### 你将学到什么

通过专栏，你将可以学到推荐系统中所需的几乎全部的技术，包括常用的召回算法、排序算法、评估策略，冷启动等推荐系统中的核心内容，并通过贯穿整个专栏的地鼠商城点击率预估示例来解释推荐系统中的诸多概念，抛出推荐系统中的诸多常见问题以及其对应的解决方案。所有的解决方案均来自于笔者在搭建以及优化地鼠商城个性化推荐系统过程中被证明行之有效的实战经验。

学完专栏后，读者将有能力从 0 到 1 搭建一套完整的推荐系统，以及在搭建后不断优化的迭代过程中，给出良好的优化方案，提升 **点击率/转化率**
等业务指标。

专栏中的算法均优先考虑分布式实现，而非单机演示，毕竟地鼠商城可是日活千万用户、百万商品呢。

让我们从这里开始。

* * *

注释 1：本文的推荐特指个性化推荐，下同。

注释 2：参见 <https://arxiv.org/abs/1606.07792>

