## 一、前言

> MySQL 是一个关系型数据库管理系统，由瑞典 MySQL AB 公司开发，属于 Oracle 旗下产品。MySQL
> 是最流行的关系型数据库管理系统之一，在 WEB 应用方面，MySQL 是最好的 RDBMS (Relational Database
> Management System，关系数据库管理系统) 应用软件之一。

阅读到这篇文章的小伙伴，或多或少都是使用过关系型数据库的，或者是 Mysql、或者是 Oracle
等等，这些数据库的使用主要用于业务系统中进行数据的承载，满足业务诉求。例如，我们要保存和查询用户信息，记录聊天记录等等。同时有的时候为了满足大体量的业务行为，还会有分库分表，以及非关系型数据库
Redis 等的使用。

那么，我们这个聊天系统主要是为了体现核心功能的实现，所以在库表设计上尽可能的会简单，并只保留核心字段的业务属性。接下来，我们开始进行库表的设计。

## 二、库表设计

![](https://images.gitbook.cn/n70FlT)

  * 对于我们的业务功能需要有这么六个表来完成业务流程，而这六个表可以分为三个部分来看；

  * 第一部分，基础表；也就是用户和群组的维护

  * 第二部分，关联表；每个用户与好友和群组的关系

  * 第三部分，行为表；每一个用户都会与自己的好友或者群组产生对话，以及最终的聊天记录

  * 接下来我们逐个表的进行分析，看每一个表的与 UI 的具体业务关联性。

  * 建表语句可以从工程源码中进行获取；<https://github.com/itstack-naive-chat>

### 1\. 用户表

![](https://images.gitbook.cn/Olc4ZE)

  * 对于用户表首先第一个使用的地方就是登录，在登录的时候需要进行身份校验。再者就是有关于用户信息详情的展示。

  * **库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | userId | varchar(9) | 用户 ID  
3 | userNickName | varchar(32) | 用户昵称  
4 | userHead | varchar(16) | 用户头像  
5 | userPassword | varchar(64) | 用户密码  
6 | createTime | datetime | 创建时间  
7 | updateTime | datetime | 更新时间  
  * **样例数据**

id | userId | userNickName | userHead | userPassword | createTime | updateTime  
---|---|---|---|---|---|---  
1 | 184172133 | 小傅哥 | 01_50 | 123456 | 2020-01-01 00:00:00 | 2020-01-01
00:00:00  
2 | 980765512 | 铁锤 | 02_50 | 123456 | 2020-01-01 00:00:00 | 2020-01-01
00:00:00  
3 | 796542178 | 团团 | 03_50 | 123456 | 2020-01-01 00:00:00 | 2020-01-01
00:00:00  
  * 这里的头像 `userHead`，是图片的名称，默认我们设置了 10 个图片；(01-10)_50，最终的图片路径是：`/fxml/login/img/head/01_50.png`

  * 另外这里的密码是明文保存，如果是实际的业务中使用，一定要是加密处理。

### 2\. 群组表

群组表在我们系统中是默认创建的一个群组然后给每个用户分配，当然也可以在页面开发功能去创建群组。但对于我们的系统来说，我们是默认的方式，对于每一个用户都是群组里面的用户。同时也希望你在拿到源码后，可以来实现下这部分功能。

**库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | groupId | varchar(9) | 群组 ID  
3 | groupName | varchar(16) | 群组名称  
4 | groupHead | varchar(16) | 群组头像  
5 | createTime | datetime | 创建时间  
6 | updateTime | datetime | 更新时间  
  
**样例数据**

id | groupId | groupName | groupHead | createTime | updateTime  
---|---|---|---|---|---  
1 | 5307397 | 虫洞 · 技术栈 (1024) | group_1 | 2020-01-01 00:00:00 | 2020-01-01
00:00:00  
  
  * 这里的群组是我们系统进行初始化的数据，当然也可以完善代码像微信一样创建群组。
  * `groupHead`，是头像名称，最终地址会是；`/fxml/login/img/head/group_1.png`，如果这部分头像是可以上传配置的，那么需要从服务端下载到客户端并保存。

### 3\. 用户好友表

![](https://images.gitbook.cn/qzM3py)

  * 好友表主要用于维护每一个用户自己的好友信息记录，目前的表结构字段比较简单。如果是类似一个真实的微信场景，那么可能会有好友的各种信息描述，例如；添加方式 (扫码、手机号搜索、好友分享)、添加地点、添加时间，还包括你比较关心的是是否被删除等等。

  * **库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | userId | bigint(20) | 用户 ID  
3 | userFriendId | bigint(20) | 好友用户 ID  
4 | createTime | datetime | 创建时间  
5 | updateTime | datetime | 更新时间  
  * **样例数据**

id | userId | userFriendId | createTime | updateTime  
---|---|---|---|---  
1 | 184172133 | 980765512 | 2020-01-01 00:00:00 | 2020-01-01 00:00:00  
2 | 184172133 | 796542178 | 2020-02-03 13:24:00 | 2020-02-03 13:24:00  
3 | 184172133 | 523088136 | 2020-02-05 14:37:37 | 2020-02-05 14:37:37  
4 | 523088136 | 184172133 | 2020-02-05 14:37:37 | 2020-02-05 14:37:37  
5 | 184172133 | 123456003 | 2020-02-05 17:43:26 | 2020-02-05 17:43:26  
  * 在这里维护了用户的好友关系信息，并且这个关系是双向的。数据；你是我的好友，我也是你的好友。

### 4\. 用户群组表

![](https://chat.itstack.org/assets/img/2020/chat/wechat-2.4-03.png)

  * 群组表与好友表类似，群组表主要维护个人用户都参与到哪些群组里。就是你自己有一堆 QQ 群或者微信群一样的概念。并且在这个群组里目前只包括了核心的功能，很方便后续的拓展。

  * **库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | userId | varchar(9) | 用户 ID  
3 | groupId | varchar(9) | 群组 ID  
4 | createTime | datetime | 创建时间  
5 | updateTime | datetime | 更新时间  
  * **样例数据**

id | userId | groupId | createTime | updateTime  
---|---|---|---|---  
1 | 184172133 | 5307397 | 2020-01-01 00:00:00 | 2020-01-01 00:00:00  
5 | 796542178 | 5307397 | 2020-01-01 00:00:00 | 2020-01-01 00:00:00  
6 | 980765512 | 5307397 | 2020-01-01 00:00:00 | 2020-01-01 00:00:00  
  * 这里记录着用户与群组的关系，每个用户属于哪个群组。

### 5\. 对话表

![](https://chat.itstack.org/assets/img/2020/chat/wechat-2.4-04.png)

  * 对话框主要是个人与每个好友或者群组进行对话通信的记录的一个承载地方，那么这个里面的信息在用户发起聊天后就会记录到用户对话表中。当然，在删除对话框后也会从对话表中删除。同时对话框里面的信息会分为与用户兑换还是与群组进行对话，因为与个人对话则是好友的 id，与群组对话则是这个群的 id。

  * **库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | userId | varchar(9) | 用户 ID  
3 | talkId | varchar(9) | 对话框 ID(好友 ID、群组 ID)  
4 | talkType | int(4) | 对话框类型；0 好友、1 群组  
5 | createTime | datetime | 创建时间  
6 | updateTime | datetime | 更新时间  
  * **样例数据**

id | userId | talkId | talkType | createTime | updateTime  
---|---|---|---|---|---  
3 | 980765512 | 184172133 | 0 | 2020-01-01 00:00:00 | 2020-01-01 00:00:00  
28 | 184172133 | 123456003 | 0 | 2020-02-05 17:46:56 | 2020-02-05 17:46:56  
29 | 123456003 | 184172133 | 0 | 2020-02-05 17:46:56 | 2020-02-05 17:46:56  
53 | 184172133 | 5307397 | 1 | 2020-02-07 15:45:13 | 2020-02-07 15:45:13  
55 | 523088136 | 5307397 | 1 | 2020-02-07 16:14:09 | 2020-02-07 16:14:09  
56 | 123456003 | 5307397 | 1 | 2020-02-07 16:55:58 | 2020-02-07 16:55:58  
  * 这里主要是记录用户与个人和群组的对话框信息，也就是与用户聊天则记录好友与用户 ID、与群组聊天则记录用户与群组 ID 关系。

### 6\. 聊天记录表

![](https://chat.itstack.org/assets/img/2020/chat/wechat-2.4-05.png)

  * 聊天记录主要记录每个用户与好友或者群组的聊天消息信息，每一个聊天消息发送到服务端后都会采用异步的方式进行落库记录，以减少服务端耗时。另外这里依然是以核心的功能实现为主，随着业务的拓展可以自行添加扩展。

  * **库表信息**

序号 | 字段 | 类型 | 描述  
---|---|---|---  
1 | id | bigint(20) | 自增 ID  
2 | userId | varchar(9) | 自己 ID  
3 | friendId | varchar(9) | 好友 ID  
4 | talkType | int(4) | 对话类型；0 好友、1 群组  
5 | msgContent | varchar(512) | 消息内容  
6 | msgDate | datetime | 消息时间  
7 | createTime | datetime | 创建时间  
8 | updateTime | datetime | 更新时间  
  * **样例数据**

id | userId | friendId | msgContent | msgDate | createTime | updateTime |
talkType  
---|---|---|---|---|---|---|---  
2 | 184172133 | 523088136 | 兔兔 你几号去欧洲呀 | 2020/2/6 11:51 | 2020/2/6 11:51 |
2020/2/6 11:51 | 0  
3 | 523088136 | 184172133 | 暂时还没有计划。你呢？ | 2020/2/6 11:52 | 2020/2/6 11:52 |
2020/2/6 11:52 | 0  
4 | 184172133 | 523088136 | 我们过了元旦就的去了 | 2020/2/6 12:08 | 2020/2/6 12:08 |
2020/2/6 12:08 | 0  
5 | 184172133 | 523088136 | 看着还挺有意思的 | 2020/2/6 12:08 | 2020/2/6 12:08 |
2020/2/6 12:08 | 0  
6 | 184172133 | 523088136 | 多买点包包 | 2020/2/6 12:08 | 2020/2/6 12:08 | 2020/2/6
12:08 | 0  
7 | 523088136 | 184172133 | 破费！只能买点小东西了 | 2020/2/6 12:08 | 2020/2/6 12:08 |
2020/2/6 12:08 | 0  
8 | 523088136 | 184172133 | 你在家干啥呢 | 2020/2/6 12:08 | 2020/2/6 12:08 |
2020/2/6 12:08 | 0  
9 | 184172133 | 523088136 | 写点技术文章 | 2020/2/6 12:08 | 2020/2/6 12:08 |
2020/2/6 12:08 | 0  
10 | 184172133 | 523088136 | javafx netty springboot = 微信聊天 | 2020/2/6 12:09 |
2020/2/6 12:09 | 2020/2/6 12:09 | 0  
11 | 523088136 | 184172133 | 我想看看 | 2020/2/6 12:09 | 2020/2/6 12:09 | 2020/2/6
12:09 | 0  
12 | 184172133 | 523088136 | 还没完事，写完就给你看看 | 2020/2/6 12:09 | 2020/2/6 12:09 |
2020/2/6 12:09 | 0  
13 | 184172133 | 523088136 | 嗨 | 2020/2/6 12:44 | 2020/2/6 12:44 | 2020/2/6
12:44 | 0  
14 | 123456003 | 184172133 | 小傅哥 | 2020/2/6 13:13 | 2020/2/6 13:13 | 2020/2/6
13:13 | 0  
15 | 184172133 | 123456003 | 咋了？Alexa | 2020/2/6 13:13 | 2020/2/6 13:13 |
2020/2/6 13:13 | 0  
16 | 123456003 | 184172133 | 你们那几号放假呀 | 2020/2/6 13:13 | 2020/2/6 13:13 |
2020/2/6 13:13 | 0  
17 | 184172133 | 123456003 | 不知道呀还没放呢 | 2020/2/6 13:14 | 2020/2/6 13:14 |
2020/2/6 13:14 | 0  
18 | 184172133 | 523088136 | 你！ | 2020/2/6 19:26 | 2020/2/6 19:26 | 2020/2/6
19:26 | 0  
19 | 184172133 | 523088136 | 嗨 | 2020/2/6 19:38 | 2020/2/6 19:38 | 2020/2/6
19:38 | 0  
20 | 184172133 | 523088136 | 兔兔 | 2020/2/6 20:07 | 2020/2/6 20:07 | 2020/2/6
20:07 | 0  
21 | 184172133 | 523088136 | 嗨 | 2020/2/6 20:13 | 2020/2/6 20:13 | 2020/2/6
20:13 | 0  
22 | 184172133 | 523088136 | 兔兔出来玩呀 | 2020/2/6 20:16 | 2020/2/6 20:16 |
2020/2/6 20:16 | 0  
  * 这里面记录着每一个用户与好友和群组的聊天记录，因为这里目前这个只是体现核心功能，并没有记录到分库分表以及 ES 等文件系统，如果是业务级使用，需要进行扩展。

## 三、代码结构

在有了库表的结构后，我们可以使用 Mybatis
框架将库表结构初始化到代码中，同时也可以有一些基础的查询语句。但是每个人的习惯和要求不一样，所以我比较喜欢手写，这样的代码比较干净可控。尤其是在下次新增字段后，而我又添加了属于自己编写的查询语句，那么这个时候就比较难维护，不利于代码的扩展性。

    
    
    itstack-naive-chat-server
    └── src
        └── main
            ├── java
            │   └── org.itstack.naive.chat
            │       └── infrastructure
            │            ├── common
            │            ├── dao
            │            │   ├── IChatRecordDao.java
            │            │   ├── IGroupsDao.java
            │            │   ├── IGroupsMemberDao.java
            │            │   ├── ITalkBoxDao.java
            │            │   ├── IUserDao.java
            │            │   └── IUserFriendDao.java
            │            └── po
            │                 ├── ChatRecord.java
            │                 ├── Groups.java
            │                 ├── TalkBox.java
            │                 ├── User.java
            │                 ├── UserFriend.java
            │                 └── UserGroup.java
            └─ resources
                ├── config
                └── mapper
                    ├── ChatRecord_Mapper.xml
                    ├── Groups_Mapper.xml
                    ├── TalkBox_Mapper.xml
                    ├── User_Mapper.xml
                    ├── UserFriend_Mapper.xml
                    └── UserGroup_Mapper.xml                   
    

  * Mybatis 和数据的结合使用，需要添加三部分内容；

  1. 数据库 PO 对象类
  2. 数据库操作方法 DAO
  3. Mapper 文件配置

  * 如果想了解 Mybatis 为什么只是定义一个接口，就可以和配置文件中的 CRUD 操作进行关联操作。那么可以看下我的这个文章 [《源码分析 | Mybatis 接口没有实现类为什么可以执行增删改查》](https://bugstack.cn/itstack-demo-any/2019/12/25/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Mybatis%E6%8E%A5%E5%8F%A3%E6%B2%A1%E6%9C%89%E5%AE%9E%E7%8E%B0%E7%B1%BB%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html)
  * 关于以上所有的代码信息比较重复且不含有业务属性，这里就不展示了，可以从源码中查看。

## 四、总结

  * 一个好的库表设计关系整个系统功能的设计，同时并不是数据库表驱动了设计，而是因为有设计内容，才会创建库表信息。这个思路有明确。
  * 以上的库表信息建设完成以后，我们就可以开始开发我们的业务流程。从后面的代码中我们会逐步完善我们的聊天功能；从登录、到添加好友、到选择好友进行聊天。
  * 在没有进行下一个章节之前，可以先主动思考下，关于登录你能想到哪中方式进行实现。那么又是时候进行 `socket` 链接的、什么时候进行用户校验的、怎么初始化登录后的数据的，等等，可以带着这些问题主动进行思考。

