敏捷倡导小批量、短周期，但经典的敏捷只覆盖软件研发阶段，上线后的运维方式仍然保持原样，开发与运维之间的矛盾日益显著。敏捷实践者们从软件研发开始向运维侧延展，发展出了持续交付和
DevOps。

* * *

“请问 Jez 桑，你说的‘集体代码所有制’是什么意思？”一位中年日本人站起身，鞠了一个躬，礼貌地问道。

这是 2011 年 7 月，东京的一处培训教室。讲台上站着的讲师个头矮壮，有乱糟糟的黄色短发和胡须，他就是日本人尊称的“Jez
桑”，ThoughtWorks 的持续交付工具 Go 的产品经理。讲台旁边坐着的光头大胡子是 Martin
Fowler，日本人也按照他们的习惯尊称他“Martin桑”。台下坐着 40 多位听众，都是来自软银、东芝等知名企业的软件工程师和管理者。

“集体代码所有制的意思就是，项目所有的代码由项目团队所有人共同拥有，”Jez
耐心地回答道，“为了减少移交、等待、工作量不均衡造成的浪费，我们采用一种更简单的代码所有制结构：所有人拥有所有代码，每个人都可以根据需要修改任何一处代码。如果你发现一个
Bug，你不用大费周章地去找到这个模块的拥有者、告诉他 Bug 的情况、等他给你修改，你可以自己动手修改。”

“谢谢你 Jez 桑，你解释得很清楚，”提问的这位中年人又鞠了一个躬，“那么如果修改出了错误，应该谁来承担责任呢？”

“这是个好问题，”Jez
露出了“一切尽在掌握”的得意笑容，“我们认为团队应该共享责任和收益。如果出了问题，是整个团队的责任；产品成功，整个团队会受益。团队应关注全局，而不是只关注自己的岗位。”

“啊……Jez 桑，”中年人又鞠了一个躬，“这在我们日本恐怕不行……在我们日本，犯错的人要切腹谢罪的……”

听完翻译解释“harakiri”（腹切り）是什么意思，Jez 的笑容尴尬地凝固在脸上。

![](https://images.gitbook.cn/7a02c220-39d1-11e9-acbb-b5dc84d0df76)

* * *

### 持续交付的起源

2006 年，ThoughtWorks 决定启动一系列 **与敏捷相关的研发工具产品** ，其中一个产品的想法是在开源的持续集成工具
CruiseControl 基础上开发一个商业的、功能更强大的持续集成工具。

在后来的 8 年中，这个产品几经更名，由 CruiseControl Enterprise（CCE）到 Cruise，到 Go，再到 GoCD。2014 年
2 月，由于销量低迷、缺乏商业前景，ThoughtWorks 重新将 GoCD 开源。此时市场上最流行的持续集成工具早已变成了 Jenkins。

用了 8 年时间和数千万美元投资，ThoughtWorks 的产品战略除了把曾经最流行的持续集成工具做得销声匿迹之外，也为行业积淀了一个重要的概念：
**持续交付** 。

2006 年到 2009 年，CCE/Cruise 的 **产品研发** 主要在中国进行。曾经在此期间担任 Cruise
交付经理的乔梁回忆，后来持续交付理论体系中的很多实践方法，正是在这个产品的研发过程中通过“吃自己的狗粮”逐渐积累起来的。例如在开发过程中，该团队有很多种的自动化测试，而且每周都要将最新构建部署到自己的服务器上，供团队自己做持续集成，每两周会发布到公司内部的服务器上供其他团队使用。所以，该团队本身就需要有一种能够对开发过程进行建模的发布管理工具。

“ **部署流水线**
”的概念，就是他们在做这个产品的时候演进出来的。再例如书中讲到的云端测试，当时产品研发中也用到了：在做测试的时候，团队会利用命令行方式启动 EC2
中的数十台机器，将产品部署到上面，执行一系列的测试后，再将结果传回来，然后自动关掉那边的虚拟机，从而解决了硬件不足的问题1。

![](https://images.gitbook.cn/1bf46e30-39d2-11e9-bc35-6bcde500cd1b)

时任 ThoughtWorks 产品团队技术主管的 Dave Farley 将这些实践方法加以总结，提出了 **全生命周期持续集成** 的模型。

在这个模型中，Farley 把持续集成描述为一条生产流水线， **流水线分成两个部分**
：第一部分与构建相关，第二部分与部署相关。每当有人改动源代码，提交到代码仓库时就会首先触发第一部分的构建，经过编译和单元测试后，打包形成可运行的软件；随后，打好包的软件就会进入流水线的第二部分，被部署到标准化的基础设施上，经过（自动和手动的）验收测试、性能测试、集成测试之后，部署到生产环境2。这个涉及“全生命周期”的“流水线”隐喻，就是持续交付理论的基础。

与一般意义上的持续集成相比，持续交付最大的区别是 **涉及范围的扩展**
。一般意义上的持续集成只相当于上述流水线中的第一部分：每当有人向团队主干版本提交新的修改，立即执行完整的软件构建过程，将源代码编译、打包成可执行的状态，并执行所有自动化测试用例3。

而 Farley 提出的流水线则覆盖了软件向生产环境部署的过程。这个变化极大地提高了软件部署上线过程的自动化程度、降低了出错几率。后来，Humble 和
Farley
继续完善了流水线模型，将其拓展为“持续交付”的概念，核心就是以高度自动化的方式进行软件的构建、部署、测试和发布，其目的是回答这样一个问题：如果有人想到了一个好点子，我们如何以最快的速度将它交付给用户？4

### 互联网企业迅速接纳持续交付

2010 年离开 ThoughtWorks 后，乔梁在百度任高级架构师，继续推广持续交付。当时百度的产品普遍交付周期较长，开发完成的功能经常要等 3
个月才能上线。乔梁进入百度后负责指导的第一个产品曾有一个版本半年没有一次上线，后来该版本包含的功能特性被取消，整个版本研发的工作量都浪费了。

在乔梁的指导下，该产品团队开始实施持续交付，引入了自动化的测试、部署等若干实践，用了半年时间， **将发布周期从 3 个月缩短到 3 周**
。后来该团队继续将发布周期缩短至 2 周。团队成员认为实际上可以做到每周上线，但业务上没有这样频繁上线的诉求，因此保持了每两周一次上线的节奏5。

2011 年前后，Jez Humble 与 Martin Fowler 共同开发了一套 **由十余个模块组成的持续交付培训课程**
，并在全球各地推广。随着持续交付、缩短交付周期等理念被广泛认知，一些国外互联网企业高频度、短周期部署的数据开始被国内同行所留意。

在 **2011 年 9 月** 的敏捷中国大会上，乔梁和李剑在他们的演讲中提到，照片管理网站 Flickr 每天部署超过 10 次，工艺品电商网站
Etsy 每个月部署超过 400 次、在最近 1644 次部署中只发生 4 次事故、平均事故恢复时间仅 6 分钟6。

这些数据对于国内互联网企业是极具震撼力的。在随后几年中，各家互联网大厂纷纷上马持续交付。2013 年，乔梁在腾讯“电脑管家”产品团队负责研发改进。此时，这支
400 人的团队经常两三个月没有可以发布的稳定版本，被评为腾讯内部所有产品中最需改进的产品第二名。经过 3
个月的密集改进，该团队做到了每天可以交付两个可以对外发布的 beta 版本、每周有一个稳定的发布候选版本、每月一次全网稳定发布。

**改进后** ，软件的基本质量得到保障，软件崩溃率下降了
90%，产品品牌在腾讯精品软件中排名第五，进步排名第三7。即便是受到严格的金融监管的支付宝，也在环境自动化、测试自动化、运维自动化等方面下功夫，力求做到“想发就发”的持续交付8。

![](https://images.gitbook.cn/57da5580-39d3-11e9-8526-3505a4e76688)

在距离互联网较远的企业 IT 环境中，持续交付遇到了 **更大的挑战** 。

一方面是技术能力的局限。正如乔梁所说，在整个敏捷的实施过程中，“持续交付……是最难的一个环节，需要一定的技术提升，而不仅仅是靠流程。……Scrum
的门槛低，大家都能采纳，这就迎合了一些需求，能够在开始的时候让过程变得有规律可循，并达到一些效果。……如果真的想做好，技术环节是逃不掉的”9。与互联网企业相比，传统
IT 组织（除华为等少数特例外）对技术人才吸引力下降，技术能力普遍不足，实施持续交付困难重重。

另一方面，传统 IT
组织的结构和文化也对持续交付提出了挑战：持续交付的实施需要改变部署乃至线上系统运维的流程，而这个流程传统上是由独立于软件研发的运维团队来执行的。一个覆盖软件交付全生命周期的持续交付流水线，必然跨团队、跨部门，尤其是需要跨越研发和运维两类传统上泾渭分明的
IT 组织10。来自技术、组织结构和文化的挑战，将持续交付的实践者们引向一个新的知识领域。

### DevOps：架起研发和运维的桥梁

DevOps 这个名词本身就蕴含着一种强烈的 **矛盾和张力** 。正如这个词的创造者、比利时独立 IT 咨询师 Patrick Debois 在 2007
年就已注意到的，开发团队和运维团队的工作方式和思维方式有巨大的差异，敏捷的流行则使这种差异变得更加引人注目：当开发团队（Dev）遵循敏捷宣言的指导、与用户紧密协作并积极拥抱变化时，运维团队（Ops）正在像消防员一样在生产系统上四处扑火、并对一切变化深恶痛绝。

经过数年积淀，Debois 于 2009 年在比利时召开了名为“DevOpsDays”的技术会议，并由此衍生出“DevOps”这个词11。

“IT 运维”是 1990 年代以后随着企业级定制化软件应用（例如 MIS、ERP 等）的流行而产生的概念，其责任是要为内部和外部客户的应用部署提供
**平滑的基础设施和操作环境** ，包括网络基础设施、服务器和设备管理、计算机操作、ITIL 管理，甚至作为组织的 IT 帮助中心。企业的 IT
部门不仅要维护计算机和网络设备，还要维护运行在上面的软件系统，尤其是定制化的企业级软件产品，因此在定制化企业级软件交付从乙方交付给甲方的时候需要一系列的技术审查以确保质量12。

随着互联网的普及，软件修改和发布的周期越来越短，开发和运维两种岗位之间的 **矛盾**
愈发凸显：开发的工作是给应用系统增加新功能和修复软件的缺陷，这一系列价值的产生是通过应用系统变更实现的；运维的工作则是让应用系统保持稳定和高性能，即最大化缩短宕机时间并能够提升应用系统的性能，而实现“不宕机”最简单的办法就是“不要修改软件”。

在这种想法的驱动下，运维团队往往倾向于严控软件上线流程、减少软件上线次数，其结果是开发团队自己以短周期迭代，但迭代的产物不能频繁上线，因此也无法得到真实用户的反馈。

**DevOps 运动的目标就是要将敏捷倡导的快速变化、频繁反馈的工作方式延展至运维阶段** 。为了达到这一目标，DevOps
的实践者们使用了包括持续交付、云计算/虚拟化、基础设施即代码、Docker、自动化运维等技术手段，并发展出了使 Dev 和 Ops
融合协作的团队形式和组织文化13。

![](https://images.gitbook.cn/f8e59930-39d3-11e9-8526-3505a4e76688)

毫不意外，首先应用 DevOps 的是一批 **互联网企业** ，例如澳大利亚的房地产中介网站 REA 在 2012 年之前已经比较全面地实施了
DevOps 的工具与流程14。当时 ThoughtWorks 西安分公司与 REA 有大量离岸外包合作，ThoughtWorks 的咨询师从 REA
学到了这些工具与流程，为后来在国内开展 DevOps 相关的业务打下了基础。

继互联网企业之后，国内的 **银行和电信企业** 也陆续开始注意到 DevOps 的重要性。招商银行于 2015 年采购了青云的私有云软件平台，打造新一代
DevOps 应用云，将开发、运营和质量保障紧密结合，为开发测试人员提供更加快捷、简便的自助式虚拟资源配置功能，并同时帮助 IT
部门加强对设备、策略、成本的控制，从而加速业务产品和功能的迭代，更好地适应金融行业的发展与创新15。

光大银行据说从 2013 年已经在尝试将 DevOps 引入企业之中，并从制度、流程、架构各方面来推动 DevOps 在光大银行的实施，并因此于 2017
年获得云计算技术供应商 BMC 颁发的“最灵活敏捷应用交付奖”16。

中国银行在 2014 年之前引入持续集成，从 2015 年起逐步实施持续交付和 DevOps，到 2017
年已经在协作流程、技术框架和技术规范、能力建设、工具支撑等方面取得一定成效，交付流水线贯穿了从需求到运维到反馈整个端到端的过程17。

在优普丰咨询师的帮助下，浙江移动也在 2016 年实施敏捷与 DevOps，并于 2018 年 6
月获颁《研发运营一体化能力成熟度模型》评估证书，成为全国首个研发运营一体化能力成熟度评估企业18。

细看浙江移动的 DevOps 实施案例，我们会看到很多熟悉的要素，例如重构、持续集成、自动测试等19。这也是国内传统企业实施 DevOps
时常见的一种情况：由于此前没有实施敏捷、或者在实施敏捷时只偏重 Scrum 管理实践而忽视了技术实践，导致无法做到短周期频繁交付可工作的软件，因而
**需要以“DevOps”的名义补上之前不足的敏捷技术实践** 。

### 参考文献

1 [何逸勤.乔梁：持续交付将变成必备能力（图灵访谈）](http://www.ituring.com.cn/article/497)[EB/OL].  
2 ThoughtWorks公司编著.软件开发沉思录 ThoughtWorks文集[M].人民邮电出版社,2009.  
3 [Martin Fowler.Continuous
Integration](https://www.martinfowler.com/articles/continuousIntegration.html)[EB/OL].  
4 （英）亨布尔,（英）法利著.持续交付 发布可靠软件的系统方法[M].人民邮电出版社,2011:2.  
5 [乔梁.持续交付七巧板，从腾讯和百度的案例说起](http://www.sohu.com/a/163003107_609518)[EB/OL].  
6 乔梁和李剑在2011年“敏捷中国”技术大会上题为《持续交付》的演讲  
7 [乔梁.持续交付七巧板，从腾讯和百度的案例说起](http://www.sohu.com/a/163003107_609518)[EB/OL].  
8 廖光明在第二届CDConf上题为《大象如何跳舞 -支付宝持续交付实践》的演讲  
9 [何逸勤.乔梁：持续交付将变成必备能力（图灵访谈）](http://www.ituring.com.cn/article/497)[EB/OL].  
10 韩锴在第二届CDConf上题为《互联网转型企业的持续交付之路》的演讲  
11 [顾宇.#DevOps的前世今生# 1.
DevOps编年史](https://www.jianshu.com/p/f40209023006)[EB/OL].  
12 [顾宇.#DevOps的前世今生# 2. Dev和Ops矛盾缘何而来
？](https://www.jianshu.com/p/c6573e63c752)[EB/OL].  
13 [顾宇.关于 DevOps ，咱们聊的可能不是一回事](https://www.jianshu.com/p/645bb1283a77)[EB/OL].  
14 [满成圆.基于微服务的Real
DevOps实践](https://gitbook.cn/books/58e391f89ad722d562790331/index.html)[EB/OL].  
15 [招商银行新一代 DevOps
应用云](http://cloud.it168.com/a2015/1030/1773/000001773182.shtml)[EB/OL].  
16
[孙浩峰.光大银行IT管理进阶之路](https://www.csdn.net/article/a/2017-03-03/15881921)[EB/OL].  
17 [张新.中国银行 DevOps 历程、
效果及展望](https://cloud.tencent.com/developer/article/1086663)[EB/OL].  
18 [浙江移动首批通过 DevOps
评估并获三级，这是什么水平？](https://cloud.tencent.com/developer/article/1172760)[EB/OL].  
19 李海传在TiD 2016质量竞争力大会上题为《浙江移动敏捷与DevOps尝试》的演讲

### 畅聊技术历史与人生

我们希望订阅课程的朋友们可以一起把酒言敏捷，分享技术世界的一切趣事，畅聊各自的技术人生。《敏捷中国史》是普通 IT
人形塑历史的故事，也是永远不会完结的技术旅程。你可以将自己的想法发表在评论区，也可以加入《敏捷中国史》交流群，小到我们一起完善这部作品，大到共同创造未来更好的
IT 世界。（入群请加 GitChat 小助手伽利略的微信，ID 为 GitChatty6，回复关键字「246」。）

