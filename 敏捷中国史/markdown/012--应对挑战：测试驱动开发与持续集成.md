极限编程对于软件质量保障给出的答案是测试驱动开发。这种“先写测试、再写实现”的开发方式，对于很多人而言是具有颠覆性的。在后来为数众多的关于敏捷的讨论中，测试驱动开发（和一向如影随形的持续集成）总是绕不开的核心问题。

* * *

“晓东呀，你们的测试已经失败了呀，我运行一下很多都是红的呀。”平时满脸堆笑的石一楹，此时神情严肃，“你们在怎么搞呢？测试有没有在运行？提交代码的时候有没有看测试运行的结果？”

在杭州的 IT
圈子里，石一楹是个小有名气的人物。除了在浙大灵峰科技担任技术总监，还有几家当地的软件公司邀请他做兼职顾问，在架构和开发方法上给些指导。北大青鸟就是他顾问的公司之一。杭州工商的项目启动之前，石一楹给这个项目组制定了一套从极限编程裁剪而来的开发流程，尤其是强调单元测试。刚搭好技术架构，石一楹就亲手演示了怎么写单元测试、怎么运行测试看到结果，然后手把手地教几个开发人员各自写下第一个测试用例。项目进展的过程中，他还专门来检查过两次。临近上线之前，项目组去工商局驻场闭门攻关一个月，回到公司以后测试就失败了一大片，难免让他有些失望。

“主要是在工商局临时改了好多东西，改得又急，加班加点的，就没顾得上更新测试，”何晓东有点不好意思，红着脸说道，“怪我没留意，赶着做功能那几天只看了我那一小块代码的测试，不知道是什么时候，其他测试失败了好多，还没抽出功夫来修。”

“我不是跟你们说过吗？提交代码之前一定要先运行所有测试，都通过了才能提交呀。”

“以前在公司的时候大家坚持得好一点，测试一直还是绿的，就是去驻场开发那段时间，赶得太紧，客户就在旁边催着要看修改的效果，好多时候就忘了要运行测试。”

![](https://images.gitbook.cn/04b424e0-1335-11e9-abc2-a9701a61d30b)

“哎，对了，我不是叫陈总给你们找了一台电脑，专门用来监视测试通过的情况吗？”石一楹口中的“陈总”叫陈志刚，当时在杭州北大青鸟担任技术总监，“怎么没看见你们的监视器在哪儿呢？”

“那台监视器用了一段时间，陈总看上面也没什么特别的东西，每天都是一块绿色，可能觉得也没什么用吧，新员工入职的时候就分配给别人用了，”何晓东答道，“后来我们去工商局驻场的时候都忘了这事。可能还是应该有这么一个监视器好些，不然也不至于测试都失败了我还不知道。”

“唉，你们呀，叫你们做的事情，几天不来看全都走样了，也难怪你们项目赶得辛苦。”石一楹长叹一口气，“好在你们项目总算也上线了，有点小 Bug
修修补补，大问题不会有了。下一个项目争取把这些动作做得再标准一点吧。”

* * *

### 重构伴侣：测试驱动开发

**重构的目标** 是通过调整代码结构来改善软件的内部质量。为了让程序员有意愿、有勇气频繁地进行这种调整，Fowler 在 Opdyke
的研究基础上给出了一系列具体的、行为保持的重构手法。但归根到底，重构是否改变了软件可观察的行为，只能靠测试来验证。

广义而论，软件测试是指 **采用测试用例执行软件** 的活动。软件测试有两个重要的目标：找出软件中可观察的行为失败，或者演示软件正确的执行方式1。

从这个意义上，软件测试并不一定是 **自动化** 的：用纸笔把测试用例书写下来，用人工手动逐一步骤执行测试用例，同样是可能的测试方式——实际上，回到
2004 年前后，这也是行业中普遍的测试方式。

但重构的高频度给测试带来了新的挑战。按照 Fowler
的演示，程序员可能在一小时的开发工作中进行数次重构2。如果每次重构之后都必须手动执行测试用例（即使只是一部分测试用例）来验证软件的行为是否被改变，会使重构变成一件极其麻烦而高风险的事，从而使程序员丧失频繁重构的意愿与勇气。因此，极限编程有另一个与重构如影随形的实践：
**测试驱动开发** ，或称测试优先编程。

在测试驱动开发的上下文中， **测试**
必须可以自动运行。这些测试本身也是软件程序，使用特定的编程语言和框架来编写，可以在特定的测试工具中执行。当它们被执行时，它们会自动运行需要被测试的软件，验证其行为与预期是否吻合。

极限编程将自动化测试分为两类： **单元测试** 采用与开发软件相同的编程语言，使用 JUnit 等工具，测试软件中基础的小单元（例如类、函数）；
**验收测试** 通常采用某种更贴近自然语言的脚本语法，使用 Selenium 之类的工具，模拟最终用户的行为直接操作软件。

不管哪类测试、使用何种测试工具，都有一些共同的 **约定俗成** ，例如测试失败时的提示为红色，测试成功时提示绿色。

极限编程的观念认为，在接到任务时，开发团队应该首先编写“红色”的测试来描述自己想要完成的任务；然后编写代码实现该任务，使测试变成“绿色”；然后通过重构调整优化代码结构，此时测试仍然保持“绿色”，这就是一个完整的开发周期。

“鲍勃大叔” Robert Martin 称这个周期为 **红—绿—重构**
3。极限编程社区认为，这样一个周期通常应该在数分钟到数十分钟内完成，从而确保程序员的注意力高度集中。为了满足这种高频执行的需要，除了自动化之外，极限编程的实践者们对于测试还有一些常见的要求，例如：

  * **一键执行** ：输入一个快捷键组合或一条命令可以执行所有测试用例；
  * **快速** ：应该能在很短的时间（通常不超过几分钟）内执行所有测试用例；
  * **可重复** ：在不修改程序和测试的前提下多次执行、在不同电脑上执行会得到同样的结果。

![](https://images.gitbook.cn/449d3a60-1335-11e9-abc2-a9701a61d30b)

伴随这样快节奏的周期循环，一支普通规模的开发团队（通常包含 4~10 名开发人员）会很快积累起大量的 **测试用例** 。例如 ThoughtWorks
的一个项目在 6 个月中进行了约 2400 次代码提交，平均每一对程序员（该项目采用结对编程的工作方式）每天提交 6 次，积累了约 8600 行生产代码和约
13000 行测试代码4。

在这样高频度、快节奏的开发过程中还能保持所有测试随时成功、整个软件随时处于可用状态，单靠程序员的自觉是肯定不够的，必须有严明的纪律，以及便利的工具来确保纪律落实。

### 持续集成：极限编程的质量基础

对于“如何保障软件质量”这个问题，极限编程给出的答案是： **靠自动化测试保障软件可观察的外部质量；靠重构保障软件内部设计质量** 。

正如前文所说，在通常为期数月的项目交付过程中，能保证不断增加的自动化测试用例始终处于成功状态就已属不易，能不断关注和改进内部质量的团队更是罕见。极限编程保障这些严格的纪律落到实处的办法，是一系列配置管理的实践。

首先，极限编程提倡采用 **单一代码库** ，而不采用 **多分支开发**
：程序员可以在一个临时分支（包括在自己电脑上签出的本地代码库）上做开发，但临时分支与团队共有的主干版本应该频繁保持同步，两者不同步的状态不应该超过几个小时5。这个实践要求程序员非常频繁地向整个团队提交他们的工作进展，因为提交越是不频繁，程序员彼此的修改互相冲突的可能性就会越大，解决冲突的成本也会越高。

极限编程的团队协作方式（结对编程、轮换结对等）对频繁提交也起到了 **促进作用**
，但即使没有结对编程，单一代码库仍然是一个很容易检查、度量和可视化的实践：如果有必要的话，团队领导者可以从配置管理工具（例如
CVS、Subversion）上很容易地了解到每个程序员是否每天至少有一到两次提交，从而大致了解临时分支与团队主干的同步情况。

**容易检查、度量和可视化** ，是极限编程中这一系列配置管理实践的共同特征，也是这些实践能成为纪律保障机制的重要原因。

当程序员能够习惯每天数次提交最新的代码修改，极限编程提出了更进一步的要求：他们不仅应该随时保持团队主干版本的更新，而且应该随时保持团队主干版本的高质量——也就是说，所有自动化测试都应该成功。

Martin Fowler 在 2000 年 9 月题为“持续集成”的文章里介绍了 ThoughtWorks
一支项目团队的实践：以很高的频率（每天多次）构建整个软件、并执行自动化测试6。后来 Fowler 更加明确地阐述了 **持续集成的实践方式**
：每当有人向团队主干版本提交新的修改，立即执行完整的软件构建过程，将源代码编译、打包成可执行的状态，并执行所有自动化测试用例7。

当持续集成得到严格执行时，也就意味着每当软件代码发生一点变更（一天多次），就会全面地、自动地测试整个软件。这个机制能有效地保障软件的质量，并且测试用例也不会因为长期失去维护而大面积失效。但如何严格执行持续集成是一个难题。Fowler
指出，持续集成的实施需要 **流程和技术的双重保障** 8：

  * 从流程上，持续集成的工作方式要求开发者遵循一系列具体的操作规范，尤其是在开始编程之前更新本地代码副本、结束编程任务之后在本地执行完整构建、提交代码之后确保团队主线上的构建成功。
  * 从技术上，持续集成的工作方式需要构建自动化、测试自动化、部署自动化等技术手段的支持，并且通常需要用到专门的持续集成服务器工具。

![](https://images.gitbook.cn/4ab2b150-1335-11e9-abc2-a9701a61d30b)

在经典软件工程理论中， **配置管理**
的定义是“跟踪与控制软件变更的任务”9。持续集成正是在版本控制的基础上，用一组流程与技术手段对软件的变更过程进行控制。从这个意义上，持续集成应该被视为极限编程方法中核心的配置管理实践。

然而，在落地实施时，尽管在流程和技术上的挑战同样不容忽视，但一支刚开始实施敏捷的团队往往会首先面临另一个更直接的问题：为什么需要以这种节奏开发软件？这个问题的背后，是
**两种项目管理理念** 的冲突与交锋。

### 参考文献

１ （美）乔根森著.软件测试[M].人民邮电出版社,2011.  
２ ￼[美]马丁•福勒（Martin Fowler).重构[M].人民邮电出版社,2015:7.  
３ ￼[Robert C. Martin.The Cycles of TDD](http://blog.cleancoder.com/uncle-
bob/2014/12/17/TheCyclesOfTDD.html)[EB/OL].  
４ ￼[熊节.Starwood Footprint](http://gigix.thoughtworkers.org/2008/9/19/starwood-
footprint/)[EB/OL].  
￼５ （美）贝克（Beck,K.）著,雷剑文.解析极限编程 拥抱变化 第2版[M].电子工业出版社,2006:68.  
￼６ [Martin Fowler.Continuous Integration (original
version)](https://www.martinfowler.com/articles/originalContinuousIntegration.html)[EB/OL].  
７ ￼[Martin Fowler.Continuous
Integration](https://www.martinfowler.com/articles/continuousIntegration.html)[EB/OL].  
８ ￼ibid  
￼９ （美）普雷斯曼著.软件工程：实践者的研究方法 原书第7版[M].机械工业出版社,2011.

### 畅聊技术历史与人生

我们希望订阅课程的朋友们可以一起把酒言敏捷，分享技术世界的一切趣事，畅聊各自的技术人生。《敏捷中国史》是普通 IT
人形塑历史的故事，也是永远不会完结的技术旅程。你可以将自己的想法发表在评论区，也可以加入《敏捷中国史》交流群，小到我们一起完善这部作品，大到共同创造未来更好的
IT 世界。（入群请加 GitChat 小助手伽利略的微信，ID 为 GitChatty6，回复关键字「246」。）

![](https://images.gitbook.cn/b52617c0-3527-11e9-ac96-ed1c76eb80e8)

分享上面的《敏捷中国史》阅读卡片，跟朋友一起了解中国软件开发方法的进化和一代程序员自我突破的故事。

