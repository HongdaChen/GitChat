软件开发中的自动化测试被广泛认为是一种不可或缺的质量门禁措施。根据我的经验，对于测试像 Kubernetes
这样的集群基础设施来说，其挑战还是很不一样的。关于如何利用和扩展现有工具来测试 Kubernetes
集群的资料也比较少，所以笔者将在本文中分享整理出来经验。

### 测试痛点

利用自动化工具测试集群状态是有很多理由的。我们知道 Kubernetes
本身就是一套非常复杂的分布式系统，由多个组件组成，涉及到多个第三方组件的依赖。那么当我们选配好合适的组件配置成一套可运行的工作集群后，我们并不能就确信这个集群可以完美的运行。

另外社区提供了众多的官方，非官方的安装集群的工具和方法，比如实用 kubeadm 或者 k8e 等安装程序，安装程序可以通过自己的理解配置
Kubernetes 的集群配置，所以看上去不太可能有一直一成不变的配置流程。为了给用户提供稳定可靠的 Kubernetes
集群环境，我们需要通过对其进行基准冒烟测试来确保我们的设置是能够按照预期的方式工作的，进而为用户提供一个有价值的平台。如果 Kubernetes
更新不那么频繁发布，我相信人工测试也足以能有效解决这个痛点问题。但是事实上 Kubernetes
每三个月就会有一个大版本的更新迭代，它需要我们能通过更快的方式测试验证完成集群功能是否可以工作。这就催促出自动化测试的需求。

另外，Kubernetes 不仅仅是一个平台，它还通过插件和附加组件实现一些功能扩展，比如 Operator。因此，没有一项 Kubernees
配置一定要按照固定的方式运行。需要我们通过集成的测试工具来测试他们，确保万无一失。

### 一致性测试规则

Kubernetes 一致性测试是 Kubernetes 端到端（e2e）测试用例的子集，用于测试 Kubernetes
的核心功能。更具体地说，它们“目前只测试 API 的一般可用、非可选功能”，正如负责的开发者小组所说的那样。通过这些测试的集群被称为符合性，并可由 CNCF
k8s 一致性工作组进行认证。

目前测试的功能包括创建 API 对象、在节点上启动容器和挂载基本卷的能力，以及对 kubectl
的测试。不包括可选功能，如基于角色的访问控制、NetworkPolicy 和 PodSecurityPolicy。插件和附加组件也大多免于一致性测试，例如
DNS 会被测试，但使用 Weave 或 Calico
等插件的联网只被一些测试隐含要求。在未来，插件也可能通过一致性测试配置文件进行测试，但目前它们需要单独测试。

尽管如此，它们对基本集群功能的验证使得一致性测试成为测试我们集群的理想起点。要运行这些测试，我们可以使用 Sonobuoy 这样的工具。

#### **Sonobuoy**

Sonobuoy 是一个诊断工具，它可以运行 Kubernetes 一致性测试。它由一个 CLI 组成，它可以启动一个管理集群内测试运行的
pod，并让你在测试后检索结果。它是一个简单的开箱即用的解决方案，也是运行一致性测试的标准工具。Sonobuoy
带有一些自定义选项，例如为测试镜像提供自定义的镜像仓库，例如在测试私有集群时。

我们也可以选择用 Sonobuoy 来运行 e2e 测试套件的其他测试来测试我们的一些插件。例如，如果我们想验证自有集群的一致性认证测试。可以像这样用
Sonobuoy 运行一个基本的测试。

    
    
    # run sonobuoy
    sonobuoy run --wait
    

这些测试创建了基本的功能 Pod 并验证它们是否在集群中被执行。其他功能也有类似的测试。整个过程需要 1 个小时，需要耐心等待。

### Test-infra（Kubernetes 官方）

[Test-infra](https://github.com/kubernetes/test-infra) 是一个用于 Kubernetes
测试和结果验证的工具集合。Test-infra 包括一些仪表盘，用于显示历史记录，汇总失败，并显示当前正在测试的内容。你可以通过创建自己的测试作业来增强你的
Test-infra 套件。Test-infra 可以使用 Kubetest 工具在不同的提供商上进行端到端 Kubernetes 测试，并进行完整的
Kubernetes 生命周期模拟。

### 编写自己的 e2e 测试

你也可以为你的集群设置编写自己的 e2e 测试。这在运行自制插件时特别有用，因为单元测试很难模仿运行中的 Kubernetes 集群的行为。要在
Golang 中开发你的测试，你可以重用 Kubernetes [本身的 e2e
框架](https://kubernetes.io/blog/2019/03/22/kubernetes-end-to-end-testing-for-
everyone/)。

如果你使用另一种编程语言，你仍然可以使用 kubernetes 客户端库，但你将不得不自己编写一些模板代码，例如用于设置和拆卸测试命名空间。单元测试框架（如
pytest）仍然会被证明是有用的，可以将设置与测试用例分开，并运行测试和收集结果。

无论你是刚刚开始 Kubernetes 之旅，还是你已经在生产中运行集群 5 年了，我们相信你现在应该开始测试这些集群。在你的流水线中运行 Sonobuoy
进行一致性测试，开始为你使用的功能加入一些 e2e
测试，并为那个在你的集群中造成故障的组件开发你自己的测试，一次多项测试验证。这将使操作更容易，并让你安心。

### 参考资料

  * <https://kubernetes.io/blog/2019/03/22/kubernetes-end-to-end-testing-for-everyone/>
  * <https://github.com/cncf/k8s-conformance/blob/master/instructions.md>

