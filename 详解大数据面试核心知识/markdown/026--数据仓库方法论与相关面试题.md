数据仓库的概念最早是由美国著名的信息工程专家 William Inmon 博士在 1991
年提出，他的出现是因为数据量达到一定的程度，传统数据库的数据处理方案已无法支持方便地对海量数据直接做分析和处理。数据仓库对数据集合的定义是
**面向主题的、集成的、稳定的和随时间变化的** ，刚好弥补了数据库在 OLAP
方面的不足。值得说明的是，数据仓库是一个数据分析处理过程，或者说是一套数据处理的方法论，而不仅仅是一个数据存储软件或产品，大数据的工作很多都是基于数据仓库展开的，所以数据仓库方法论是除了大数据底层技术之外非常重要的一块面试内容。

**本篇面试内容划重点：维度建模、分层思想。**

### 数据建模

#### **数据建模有什么意义（作用）？**

数据模型就是数据组织和存储方法，它强调从业务、数据存取和使用角度 **合理存储数据**
。只有数据模型将数据有序的组织和存储起来之后，大数据才能得到高性能、低成本、高效率、高质量的使用。

  * **性能** ：帮助我们快速查询所需要的数据，减少数据的 I/O 吞吐，提高使用数据的效率，如宽表。
  * **成本** ：极大地减少不必要的数据冗余，也能实现计算结果复用，极大地降低存储和计算成本。
  * **效率** ：在业务或系统发生变化时，可以保持稳定或很容易扩展，提高数据稳定性和连续性。
  * **质量** ：良好的数据模型能改善数据统计口径的不一致性，减少数据计算错误的可能性。

大数据系统需要数据模型方法来帮助更好地组织和存储数据，以便在 **性能、成本、效率和质量** 之间取得最佳平衡。

#### **用什么方法来建模？**

数据建模方法业界比较通用的方式有两种，维度建模和关系建模，维度建模更适合互联网公司，关系建模更时候传统公司。

**1\. 维度建模**

维度模型是数据仓库领域一位大师 Ralph Kimball
所倡导的。维度建模以分析决策的需求出发构建模型，构建的数据模型为分析需求服务，因此它重点解决用户如何更快速完成分析需求，同时还有较好的大规模复杂查询的响应性能，更直接面向业务。典型的代表是星形模型。

**星型模型**

![image.png](https://images.gitbook.cn/3ca6cd80-096a-11eb-a23c-cb79ad67f6c6)

如上图的例子所示，星型模型由一个事实表和一组维表组成。每个维表都有一个维作为主键，所有这些维的主键组合成事实表的主键。维度建模中，多维数据集的每一个维度都直接与事实表相连接，不存在渐变维度，所以数据有一定的冗余，但是虽然有冗余但是这对于数据分析来说会比较方便，不需要去关联其他很多的表，这也是为什么大数据数仓中大家都喜欢用宽表的原因，join
操作在数仓中是比较耗时的，而且表太多会增加管理成本，所以干脆将维度退化，制作成大宽表供数据分析人员使用，但是这也是要看具体场景的，比如对于经常更新的维度来说，是否需要维度退化就需要视情况而定了。

**建模方法**

通常需要选择某个业务过程，然后围绕该过程建立模型，其一般采用自底向上（“底”指的是我们数据仓库的数据应用层，即先从应用开始考虑）的方法，从明确关键业务过程开始，再到明确粒度，再到明确维度，最后明确事实，非常简单易懂。

![image.png](https://images.gitbook.cn/50580060-096a-11eb-a2dc-733c375322f5)

**优缺点**

维度建模的优点是技术要求不高，快速上手，敏捷迭代，快速交付；更快速完成分析需求，较好的大规模复杂查询的响应性能，所以这种方式是互联网公司最常用的数据仓库建模方法；缺点是维度表的冗余会较多，视野狭窄。

**2\. 关系建模**

是数据仓库之父 Inmon 推崇的、从全企业的高度设计一个 3NF 模型的方法，用实体加关系描述的数据模型描述企业业务架构，在范式理论上符合
3NF，站在企业角度面向主题的抽象，而不是针对某个具体业务流程的实体对象关系抽象。它更多是面向数据的整合和一致性治理，正如 Inmon
所希望达到的“single version of the truth”。

**雪花模型**

仍然用之前的那个例子来看看这张图，但是由于游戏业务更关注的是用户的行为事件数据的分析，所以这个例子放在这里其实有点勉强，传统公司的数据会有很多实体，实体之间是复杂的一对多（多对一）或者多对多的关系，类似角色与装备的关系，角色与用户的关系。

![image.png](https://images.gitbook.cn/8b9a2310-096a-11eb-b8a7-43f9b203a4ce)

当有一个或多个维表没有直接连接到事实表上，而是通过其他维表连接到事实表上时（比如用户表和装备表），其图解就像多个雪花连接在一起，故称雪花模型。雪花模型是对星型模型的扩展。它对星型模型的维表进一步层次化，原有的各维表可能被扩展为小的事实表，形成一些局部的“层次”区域，这些被分解的表都连接到主维度表而不是事实表。雪花模型更加符合数据库范式，减少数据冗余，但是在分析数据的时候，操作比较复杂，需要
join 的表比较多所以其性能会比星型模型低。

**建模方法**

关系建模常常需要全局考虑，要对上游业务系统的进行信息调研，以做到对其业务和数据的基本了解，要做到主题划分，让模型有清晰合理的实体关系体系，以下是方法的示意：

![image.png](https://images.gitbook.cn/aa82bc10-096a-11eb-ad7e-c16d2fbff2ad)

**优缺点**

  * **优点是** 规范性较好，冗余小，数据集成和数据一致性方面得到重视；
  * **缺点是** 需要全面了解企业业务、数据和关系；实施周期非常长，成本昂贵；对建模人员的能力要求也非常高，容易烂尾。

这个方法是自顶向下，就是从整体出发，先确定我们目前有哪些数据，哪些业务，以及互相之间的关系，然后定义好规范，减小数据冗余。这样的话其实在最后的应用层使用数据可能就会比较恶心了，因为它不是从业务应用的角度出发去设计的，数据的获取和使用要满足整体的规范，所以可能在应用层需要做更多的关联清洗操作。

### 分层设计

#### **分层的目的？**

数仓最终数据的生成一般需要原始数据做比较多清洗和聚合操作，为了达成以下 5 点目的，我们在设计数仓的时候会把数仓分层，每一层做不同的事情，循序渐进。

  * **清晰数据分布** ：每一个数据分层都有它的作用域，这样我们在使用表的时候能更方便地定位和理解。
  * **数据血缘追踪** ：作用是能够快速准确地定位到问题，并清楚它的危害范围。
  * **减少重复开发** ：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算。
  * **把复杂问题简单化** ：将复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单和容易理解。当数据出现问题之后，不用修复所有的数据，只需要从有问题的步骤开始修复。

#### **具体的分层逻辑？**

![](https://images.gitbook.cn/cf945400-096a-11eb-9cdb-176c08cdc6bb)

ods 原始数据层，来自外部数据源的原始数据，比如业务数据库（MySQL），埋点日志（Kafka），是没有进过处理的数据。

dwd
明细数据层，这一层主要解决一些数据质量问题和数据的完整度问题。比如用户的资料信息来自于很多不同表，而且经常出现延迟丢数据等问题，为了方便各个使用方更好的使用数据，我们可以在这一层做一个屏蔽。

dws 轻度汇总层，对 dwd 层的用户行为数据做一个初步的聚合，抽象出来一些通用的维度：时间、ip、id，并根据这些维度做一些统计值。

ads 数据应用层，针对不同的应用特别定制的数据表，允许冗余，一般只有这一层的数据是对外的，所以可以在这一层控制应用的数据权限。

其它层：

  * dim 字典数据层，字典数据，数据同样来自外部数据源，一般会定时同步至这个表且不会经常变动，是国家代码和国家名、地理位置、中文名、国旗图片等信息。 
  * tmp 临时数据层，有时候计算逻辑复杂的情况下，会需要生成一些临时表来帮助梳理计算逻辑和提高计算效率，所以每一层的计算都有可能生成临时表，专设一个 TMP 层来存储我们数据仓库的临时表。

